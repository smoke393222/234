# Отладка подключения к 3x-ui

## Ваша конфигурация

```bash
XUI_BASE_URL=https://your-domain.com:PORT/path
XUI_USERNAME=your_username
XUI_PASSWORD=your_password
XUI_VERIFY_SSL=false
```

## Проблема

Бот не может залогиниться, но API работает:
- ❌ Логин: `https://your-domain.com:PORT/path/login` - не работает
- ✅ API: `https://your-domain.com:PORT/path/panel/api/inbounds/list` - работает

## Шаги диагностики

### 1. Загрузите обновленные файлы на сервер

Обновлены файлы:
- `services/xui_client.py` - добавлено детальное логирование
- `test_curl.sh` - скрипт для проверки curl
- `DEBUG_CONNECTION.md` - эта инструкция

### 2. Перезапустите бота с обновленным кодом

```bash
cd /path/to/bot

# Загрузите файлы (через git pull или scp)

# Перезапустите
docker compose down
docker compose up -d --build

# Смотрите детальные логи
docker compose logs -f
```

### 3. Попробуйте команду /settings и смотрите логи

Теперь в логах будет видно:
- Точный URL логина
- Статус ответа
- Заголовки ответа
- Полученные cookies
- Детали ошибок

### 4. Запустите тест сети

```bash
chmod +x test_network.sh
./test_network.sh
```

Этот тест покажет:
- Доступен ли хост из контейнера
- Доступен ли порт из контейнера
- Работает ли curl из контейнера
- Какие альтернативные адреса работают (172.17.0.1, localhost)

### 5. Запустите curl тест

```bash
chmod +x test_curl.sh
./test_curl.sh
```

Этот тест покажет:
- Доступна ли панель с хоста
- Работает ли логин через curl
- Какие cookies возвращаются
- Работает ли API после логина

### 6. Запустите Python тест

```bash
docker exec -it vpn_bot python test_xui_connection.py
```

## Возможные причины и решения

### Причина 1: Неправильный путь логина

**Проблема:** Возможно логин должен быть на другом пути

**Проверка:**
```bash
# Попробуйте разные варианты
curl -k https://your-domain.com:PORT/path/login
curl -k https://your-domain.com:PORT/path/panel/login
curl -k https://your-domain.com:PORT/login
```

**Решение:** Если один из вариантов работает, нужно будет изменить код.

### Причина 2: Нужна сессия или токен

**Проблема:** API может требовать предварительную сессию

**Проверка:** Смотрите в логах curl теста, какие cookies возвращаются

### Причина 3: Нужны дополнительные заголовки

**Проблема:** Панель может требовать специфичные заголовки

**Решение:** Добавим в код после анализа логов

### Причина 4: Используется другой метод аутентификации

**Проблема:** Возможно используется API токен вместо логина

**Проверка:** Посмотрите в настройках панели 3x-ui, есть ли API токен

## Следующие шаги

1. Запустите обновленный код и посмотрите детальные логи
2. Запустите `test_curl.sh` и пришлите результат
3. На основе логов определим точную причину
4. Внесем необходимые изменения в код

## Временное решение

Если логин не работает, но у вас есть доступ к панели, можно:

1. Войти в панель через браузер
2. Открыть DevTools (F12)
3. Посмотреть, какие cookies устанавливаются
4. Временно захардкодить эти cookies в бота (НЕ рекомендуется для продакшена)

## Контрольный список

- [ ] Обновлен код на сервере
- [ ] Бот перезапущен
- [ ] Проверены логи после /settings
- [ ] Запущен test_curl.sh
- [ ] Запущен test_xui_connection.py
- [ ] Определена точная причина ошибки
